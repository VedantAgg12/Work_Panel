<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspaces</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --text-color: #333;
            --bg-color: #f4f6f8;
            --card-bg: #fff;
            --border-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --text-color: #e0e0e0;
            --bg-color: #2d2d2d;
            --card-bg: #333;
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background: transparent;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            /* Fix horizontal scroll */
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: inherit;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-icon {
            background: transparent;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .btn-icon:hover {
            opacity: 1;
        }

        /* View Containers */
        #list-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            overflow-y: auto;
            flex: 1;
            padding-right: 5px;
            /* Scrollbar space */
        }

        #detail-view {
            display: none;
            flex-direction: column;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* Workspace Card */
        .ws-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 180px;
            position: relative;
        }

        .ws-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .ws-actions-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .ws-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
            padding-right: 50px;
            /* Space for actions */
        }

        .ws-desc {
            font-size: 0.9rem;
            opacity: 0.7;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .ws-meta {
            margin-top: 15px;
            font-size: 0.8rem;
            opacity: 0.5;
        }

        /* Detail Layout */
        .detail-grid {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            gap: 20px;
            flex: 1;
            overflow: hidden;
            min-height: 0;
            /* Important for nested scroll */
        }

        .col {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .col-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            background: rgba(0, 0, 0, 0.02);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .col-content {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
            overflow-x: hidden;
            /* Fix horizontal scroll */
        }

        /* Sources List */
        .source-link {
            display: block;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 6px;
            text-decoration: none;
            color: inherit;
            font-size: 0.9rem;
            word-break: break-all;
        }

        .source-link:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Editor */
        textarea.ws-editor {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: inherit;
            resize: none;
            outline: none;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.5;
            box-sizing: border-box;
            /* Fix padding issues */
        }

        /* Module Buttons */
        .mod-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: inherit;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: left;
        }

        .mod-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            color: var(--text-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: transparent;
            color: inherit;
            box-sizing: border-box;
        }

        .dynamic-list-item {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .check-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .check-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header>
        <h1 id="page-title">Workspaces</h1>
        <div style="display:flex; gap:10px;">
            <button class="btn-primary" id="btn-add-ws" onclick="openModal()">
                <i class="fas fa-plus"></i> New Workspace
            </button>
            <div id="detail-actions" style="display:none; gap:10px;">
                <button class="btn-outline" onclick="editCurrentWorkspace()">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn-outline" onclick="closeWorkspace()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>
    </header>

    <!-- List View -->
    <div id="list-view">
        <!-- populated by JS -->
    </div>

    <!-- Detail View -->
    <div id="detail-view">
        <div class="detail-grid">
            <!-- Sources -->
            <div class="col">
                <div class="col-header">Sources</div>
                <div class="col-content" id="col-sources">
                    <!-- Links -->
                </div>
            </div>

            <!-- Workspace Editor -->
            <div class="col">
                <div class="col-header">
                    Workspace
                    <span style="font-size:0.7rem; opacity:0.6;" id="save-status"></span>
                </div>
                <div class="col-content">
                    <textarea class="ws-editor" id="ws-editor" placeholder="Type here..."></textarea>
                </div>
            </div>

            <!-- Modules -->
            <div class="col">
                <div class="col-header">Actions</div>
                <div class="col-content" id="col-modules">
                    <!-- Action buttons -->
                </div>
            </div>
        </div>
    </div>

    <!-- New/Edit Workspace Modal -->
    <div id="modal-ws" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-top:0;" id="modal-title">New Workspace</h2>
            <form onsubmit="saveWorkspace(event)">
                <input type="hidden" id="ws-id">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="ws-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="ws-desc" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Modules</label>
                    <div class="check-grid">
                        <label class="check-item"><input type="checkbox" name="modules" value="task_manager"> Task
                            Manager</label>
                        <label class="check-item"><input type="checkbox" name="modules" value="idea_vault"> Idea
                            Vault</label>
                        <label class="check-item"><input type="checkbox" name="modules" value="notes"> Notes</label>
                        <label class="check-item"><input type="checkbox" name="modules" value="startup_planner">
                            Startups</label>
                        <label class="check-item"><input type="checkbox" name="modules" value="story_studio"> Story
                            Studio</label>
                        <label class="check-item"><input type="checkbox" name="modules" value="study_tracker"> Study
                            Tracker</label>
                        <label class="check-item"><input type="checkbox" name="modules" value="event_manager"> Event
                            Manager</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Sources (Links)</label>
                    <div id="source-inputs">
                        <!-- Populated -->
                    </div>
                    <button type="button" class="btn-outline"
                        style="margin-top:5px; padding: 4px 10px; font-size: 0.8rem;" onclick="addSourceInput()">+ Add
                        Link</button>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
                    <button type="button" class="btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentWorkspaceId = null;

        // Theme handling
        window.addEventListener('message', (event) => {
            if (event.data.type === 'theme-change') {
                document.documentElement.setAttribute('data-theme', event.data.theme);
            }
        });
        if (window.parent) {
            window.parent.postMessage({ type: 'request-theme' }, '*');
        }

        // --- Logic ---

        function openModal(editing = false) {
            const modal = document.getElementById('modal-ws');
            const title = document.getElementById('modal-title');

            modal.classList.add('open');

            // Reset fields if fresh
            if (!editing) {
                title.textContent = 'New Workspace';
                document.getElementById('ws-id').value = '';
                document.getElementById('ws-name').value = '';
                document.getElementById('ws-desc').value = '';

                // Reset Modules
                document.querySelectorAll('input[name="modules"]').forEach(c => c.checked = false);

                // Reset Sources
                document.getElementById('source-inputs').innerHTML = `
                    <div class="dynamic-list-item">
                        <input type="url" name="sources" class="form-control" placeholder="https://...">
                        <button type="button" class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
                    </div>
                `;
            } else {
                title.textContent = 'Edit Workspace';
            }
        }

        function closeModal() {
            document.getElementById('modal-ws').classList.remove('open');
        }

        function addSourceInput(value = '') {
            const div = document.createElement('div');
            div.className = 'dynamic-list-item';
            div.innerHTML = `
                <input type="url" name="sources" class="form-control" placeholder="https://..." value="${value}">
                <button type="button" class="btn-icon" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
            `;
            document.getElementById('source-inputs').appendChild(div);
        }

        async function editWorkspace(id, e) {
            // Prevent card click
            if (e) e.stopPropagation();

            try {
                const res = await fetch('/api/storage/workspaces.json');
                if (!res.ok) return;
                const workspaces = await res.json();
                const ws = workspaces.find(w => w.id === id);

                if (!ws) return;

                openModal(true);

                // Populate
                document.getElementById('ws-id').value = ws.id;
                document.getElementById('ws-name').value = ws.name;
                document.getElementById('ws-desc').value = ws.description || '';

                // Modules
                document.querySelectorAll('input[name="modules"]').forEach(c => {
                    c.checked = ws.modules.includes(c.value);
                });

                // Sources
                const srcContainer = document.getElementById('source-inputs');
                srcContainer.innerHTML = '';
                if (ws.sources && ws.sources.length > 0) {
                    ws.sources.forEach(src => addSourceInput(src));
                } else {
                    addSourceInput();
                }


            } catch (err) {
                console.error(err);
                alert("Failed to load workspace for editing");
            }
        }

        function editCurrentWorkspace() {
            if (currentWorkspaceId) {
                editWorkspace(currentWorkspaceId, null);
            }
        }

        async function saveWorkspace(e) {
            e.preventDefault();
            const id = document.getElementById('ws-id').value;
            const name = document.getElementById('ws-name').value;
            const desc = document.getElementById('ws-desc').value;

            // Modules
            const modules = [];
            document.querySelectorAll('input[name="modules"]:checked').forEach(c => modules.push(c.value));

            // Sources
            const sources = [];
            document.querySelectorAll('input[name="sources"]').forEach(i => {
                if (i.value.trim()) sources.push(i.value.trim());
            });

            // Load Existing
            let workspaces = [];
            try {
                const res = await fetch('/api/storage/workspaces.json');
                if (res.ok) workspaces = await res.json();
                if (!Array.isArray(workspaces)) workspaces = [];
            } catch (e) {
                console.error(e);
            }

            if (id) {
                // Edit
                const idx = workspaces.findIndex(w => w.id === id);
                if (idx !== -1) {
                    workspaces[idx].name = name;
                    workspaces[idx].description = desc;
                    workspaces[idx].modules = modules;
                    workspaces[idx].sources = sources;
                    workspaces[idx].updatedAt = new Date().toISOString();
                }
            } else {
                // New
                const newWs = {
                    id: crypto.randomUUID(),
                    name,
                    description: desc,
                    modules,
                    sources,
                    content: "",
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                workspaces.push(newWs);
            }

            // Save
            await fetch('/api/storage/workspaces.json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: workspaces })
            });

            closeModal();
            loadWorkspaces();

            // If in detail mode, update title and sources
            if (currentWorkspaceId && (id === currentWorkspaceId || !id)) { // !id means new, but currentWorkspaceId logic separate
                if (id === currentWorkspaceId) {
                    // Refresh current workspace view
                    openWorkspace(currentWorkspaceId);
                }
            }
        }

        async function deleteWorkspace(id, e) {
            e.stopPropagation();
            if (!confirm("Are you sure you want to delete this workspace?")) return;

            try {
                const res = await fetch('/api/storage/workspaces.json');
                if (res.ok) {
                    let workspaces = await res.json();
                    workspaces = workspaces.filter(w => w.id !== id);

                    await fetch('/api/storage/workspaces.json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: workspaces })
                    });

                    loadWorkspaces();
                }
            } catch (err) {
                console.error(err);
                alert("Failed to delete workspace");
            }
        }

        async function loadWorkspaces() {
            const container = document.getElementById('list-view');
            container.innerHTML = '<p style="opacity:0.6;">Loading...</p>';
            try {
                const res = await fetch('/api/storage/workspaces.json');
                let workspaces = [];
                if (res.ok) workspaces = await res.json();

                container.innerHTML = '';
                if (!Array.isArray(workspaces) || workspaces.length === 0) {
                    container.innerHTML = '<p style="opacity:0.6; padding:0 20px;">No workspaces found. Create one to get started.</p>';
                    return;
                }

                workspaces.forEach(ws => {
                    const card = document.createElement('div');
                    card.className = 'ws-card';
                    card.onclick = () => openWorkspace(ws.id);

                    card.innerHTML = `
                        <div class="ws-actions-overlay">
                            <button class="btn-icon" title="Edit" onclick="editWorkspace('${ws.id}', event)"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon" title="Delete" style="color:#f44336;" onclick="deleteWorkspace('${ws.id}', event)"><i class="fas fa-trash"></i></button>
                        </div>
                        <div>
                            <div class="ws-title">${ws.name}</div>
                            <div class="ws-desc">${ws.description || 'No description'}</div>
                        </div>
                        <div class="ws-meta">
                            ${ws.modules.length} Modules &bull; ${ws.sources.length} Sources
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (e) {
                console.warn(e);
                container.innerHTML = '<p style="color:red;">Error loading workspaces.</p>';
            }
        }

        let autoSaveTimer;
        // Watch editor for changes modules
        document.getElementById('ws-editor').addEventListener('input', (e) => {
            if (currentWorkspaceId) {
                const status = document.getElementById('save-status');
                if (status) status.textContent = 'Unsaved...';

                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveContent(currentWorkspaceId, e.target.value);
                }, 1000);
            }
        });

        async function saveContent(id, content) {
            try {
                const res = await fetch('/api/storage/workspaces.json');
                let workspaces = [];
                if (res.ok) workspaces = await res.json();

                const idx = workspaces.findIndex(w => w.id === id);
                if (idx !== -1) {
                    workspaces[idx].content = content;
                    workspaces[idx].updatedAt = new Date().toISOString();

                    await fetch('/api/storage/workspaces.json', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ data: workspaces })
                    });

                    const status = document.getElementById('save-status');
                    if (status) status.textContent = 'Saved';
                    setTimeout(() => { if (status) status.textContent = ''; }, 2000);
                }
            } catch (e) { console.error("Auto-save failed", e); }
        }

        async function openWorkspace(id) {
            currentWorkspaceId = id;
            try {
                const res = await fetch('/api/storage/workspaces.json');
                const workspaces = await res.json();
                const ws = workspaces.find(w => w.id === id);

                if (!ws) return;

                // UI Switch
                document.getElementById('list-view').style.display = 'none';
                document.getElementById('detail-view').style.display = 'flex';
                document.getElementById('btn-add-ws').style.display = 'none';
                document.getElementById('detail-actions').style.display = 'flex';
                document.getElementById('page-title').textContent = ws.name;

                // Populate Columns
                // 1. Sources
                const sourceContainer = document.getElementById('col-sources');
                sourceContainer.innerHTML = '';
                if (ws.sources && ws.sources.length > 0) {
                    ws.sources.forEach(src => {
                        const a = document.createElement('a');
                        a.href = src;
                        a.target = "_blank";
                        a.className = 'source-link';
                        a.innerHTML = `<i class="fas fa-external-link-alt" style="margin-right:8px; font-size:0.8rem;"></i> ${src}`;
                        sourceContainer.appendChild(a);
                    });
                } else {
                    sourceContainer.innerHTML = '<div style="opacity:0.5; font-size:0.9rem;">No sources added.</div>';
                }

                // 2. Editor
                document.getElementById('ws-editor').value = ws.content || "";

                // 3. Modules
                renderModuleActions(ws.modules);

            } catch (e) {
                console.error(e);
            }
        }

        function closeWorkspace() {
            currentWorkspaceId = null;
            document.getElementById('list-view').style.display = 'grid';
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('btn-add-ws').style.display = 'flex';
            document.getElementById('detail-actions').style.display = 'none';
            document.getElementById('page-title').textContent = 'Workspaces';
            loadWorkspaces();
        }

        function renderModuleActions(modules) {
            const container = document.getElementById('col-modules');
            container.innerHTML = '';

            if (!modules || modules.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; font-size:0.9rem;">No modules enabled.</div>';
                return;
            }

            // Define all possible buttons
            // Task Manager - New Task
            // Idea Vault - New Idea
            // Notes - New Note
            // Startup Planner - New Startup
            // Story Studio - New Element and New Story
            // Study Tracker - New Goal and New Subject
            // Event Manager - New Event

            const buttonDefs = [];

            if (modules.includes('task_manager')) {
                buttonDefs.push({ icon: 'fa-check-square', label: 'New Task', click: "triggerGlobal('qa-task-modal')" });
            }
            if (modules.includes('idea_vault')) {
                buttonDefs.push({ icon: 'fa-lightbulb', label: 'New Idea', click: "triggerGlobal('qa-idea-modal')" });
            }
            if (modules.includes('notes')) {
                buttonDefs.push({ icon: 'fa-sticky-note', label: 'New Note', click: "triggerGlobal('qa-note-global-modal')" });
            }
            if (modules.includes('startup_planner')) {
                buttonDefs.push({ icon: 'fa-rocket', label: 'New Startup', click: "triggerGlobal('qa-startup-modal')" });
            }
            if (modules.includes('story_studio')) {
                buttonDefs.push({ icon: 'fa-book-open', label: 'New Story', click: "triggerGlobal('qa-story-modal')" });
                buttonDefs.push({ icon: 'fa-cube', label: 'New Element', click: "triggerGlobal('qa-element-modal')" });
            }
            if (modules.includes('study_tracker')) {
                buttonDefs.push({ icon: 'fa-bullseye', label: 'New Goal', click: "triggerGlobal('qa-goal-modal')" });
                buttonDefs.push({ icon: 'fa-book', label: 'New Subject', click: "triggerGlobal('qa-subject-modal')" });
            }
            if (modules.includes('event_manager')) {
                buttonDefs.push({ icon: 'fa-calendar-alt', label: 'New Event', click: "triggerGlobal('qa-event-modal')" });
            }

            buttonDefs.forEach(def => {
                const btn = document.createElement('button');
                btn.className = 'mod-btn';
                btn.setAttribute('onclick', def.click);
                btn.innerHTML = `<i class="fas ${def.icon}"></i> ${def.label}`;
                container.appendChild(btn);
            });
        }

        window.triggerGlobal = function (modalId) {
            if (window.parent && window.parent.openGlobalModal) {
                try {
                    window.parent.openGlobalModal(modalId);
                } catch (e) {
                    console.error("Cannot call parent modal directly, trying postMessage", e);
                    window.parent.postMessage({ type: 'open-modal', modalId: modalId }, '*');
                }
            } else if (window.parent) {
                // Fallback to postMessage if direct access is blocked
                window.parent.postMessage({ type: 'open-modal', modalId: modalId }, '*');
            }
        }

        // Init
        loadWorkspaces();

    </script>
</body>

</html>