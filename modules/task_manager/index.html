<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1a73e8;
            --bg-color: transparent;
            --text-color: #333;
            --sidebar-bg: rgba(0, 0, 0, 0.05);
            --border-color: rgba(0, 0, 0, 0.1);
            --item-bg: rgba(255, 255, 255, 1);
            --table-header-bg: rgba(0, 0, 0, 0.03);
            --dropdown-bg: #ffffff;
            --dropdown-text: #333333;
        }

        [data-theme="dark"] {
            --text-color: #e0e0e0;
            --sidebar-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --item-bg: rgba(255, 255, 255, 0.05);
            --table-header-bg: rgba(255, 255, 255, 0.05);
            --dropdown-bg: #2d2d2d;
            --dropdown-text: #e0e0e0;
        }

        * {
            box-sizing: border-box;
        }

        /* Global Dropdown Fix */
        select,
        select option {
            background-color: var(--dropdown-bg) !important;
            color: var(--dropdown-text) !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            color: var(--text-color);
            background: var(--bg-color);
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-shrink: 0;
        }

        .action-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 30px;
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.5;
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn:hover {
            opacity: 0.9;
        }

        .nav-section {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .nav-item {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
            opacity: 0.7;
            transition: all 0.2s;
        }

        .nav-item:hover {
            opacity: 1;
            background: rgba(128, 128, 128, 0.1);
        }

        .nav-item.active {
            opacity: 1;
            background: rgba(26, 115, 232, 0.1);
            color: var(--primary-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        .view-container {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .view-container.active {
            display: flex;
            flex-direction: column;
        }

        /* Controls */
        .header-controls {
            display: flex;
            align-items: center;
        }

        .controls-group {
            display: flex;
            gap: 10px;
        }

        .filter-select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--item-bg);
            color: var(--text-color);
            font-family: inherit;
        }

        .filter-select option {
            background: var(--bg-color);
            color: black;
        }

        [data-theme="dark"] .filter-select option {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        /* Dropdown Fix Global */
        select option {
            background-color: var(--item-bg);
            color: var(--text-color);
        }

        select:focus {
            background-color: var(--item-bg);
            color: var(--text-color);
        }

        /* Table Layout */
        .task-table-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--item-bg);
        }

        .task-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .task-table th {
            text-align: left;
            padding: 15px;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            background: var(--table-header-bg);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .task-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .task-table tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .task-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .priority-badge {
            font-weight: 600;
        }

        .priority-high {
            color: #f44336;
        }

        .priority-medium {
            color: #ff9800;
        }

        .priority-low {
            color: #4caf50;
        }

        /* Overdue Red */
        .status-overdue {
            color: #f44336;
            font-weight: bold;
        }

        .status-select {
            background: transparent;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-family: inherit;
            cursor: pointer;
        }

        .status-select option {
            background: var(--bg-color);
        }

        [data-theme="dark"] .status-select option {
            background: #2d2d2d;
        }

        .action-icon {
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.7;
            transition: opacity 0.2s;
            color: var(--primary-color);
        }

        .action-icon.delete {
            color: #f44336;
        }

        .action-icon:hover {
            opacity: 1;
        }

        .expanded-row {
            display: none;
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .expanded-row {
            background: rgba(255, 255, 255, 0.02);
        }

        .expanded-row.show {
            display: table-row;
        }

        .expanded-content {
            padding: 20px;
        }

        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-cell {
            background: var(--item-bg);
            min-height: 100px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .calendar-cell.other-month {
            opacity: 0.4;
            background: rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] .calendar-cell.other-month {
            background: rgba(255, 255, 255, 0.02);
        }

        .day-number {
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .task-dot {
            font-size: 0.75rem;
            padding: 2px 4px;
            border-radius: 3px;
            background: var(--primary-color);
            color: white;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        [data-theme="dark"] .modal-content {
            background: #2d2d2d;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        /* Analytics Styles */
        .analytics-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .analytics-tab {
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .analytics-tab.active {
            background: var(--primary-color);
            color: white;
            opacity: 1;
        }

        .analytics-section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .analytics-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--item-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .chart-card {
            background: var(--item-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            /* min-height: 300px; Removed to fit content */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-wrapper {
            position: relative;
            height: 200px;
            width: 100%;
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="action-section">
            <div class="sidebar-section-title">Actions</div>
            <button class="btn btn-primary" onclick="openModal()">
                <i class="fas fa-plus"></i> New Task
            </button>
            <button class="btn btn-primary" onclick="exportTasks()">
                <i class="fas fa-file-export"></i> Export
            </button>
        </div>

        <div class="nav-section">
            <div class="sidebar-section-title">Views</div>
            <div class="nav-item" onclick="switchView('analytics')">
                <i class="fas fa-chart-pie"></i> Analytics
            </div>
            <div class="nav-item active" onclick="switchView('table')">
                <i class="fas fa-table"></i> Task Table
            </div>
            <div class="nav-item" onclick="switchView('history')">
                <i class="fas fa-history"></i> History
            </div>
            <div class="nav-item" onclick="switchView('calendar')">
                <i class="fas fa-calendar-alt"></i> Calendar
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="page-header">
            <h2 class="page-title">Task Manager</h2>

            <!-- Controls Area (Switched by View) -->
            <div class="header-controls">
                <button class="btn btn-outline" onclick="openFilterModal()">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="view-analytics" class="view-container">
            <div class="analytics-tabs">
                <div class="analytics-tab active" onclick="switchAnalyticsTab('overall')">Overall</div>
                <div class="analytics-tab" onclick="switchAnalyticsTab('recurring')">Recurring</div>
                <div class="analytics-tab" onclick="switchAnalyticsTab('non-recurring')">Non-Recurring</div>
            </div>

            <!-- Templates for Sections (rendered dynamically or static structure updated by JS) -->
            <!-- We will use a single container and update content to keep DOM light, or 3 separate divs? 
                 Let's use 3 separate divs to maintain state easily if needed, but JS update is cleaner for charts.
                 Actually, reusing canvas elements can be tricky with Chart.js if not destroyed properly.
                 Let's use ID-based sections. -->

            <div id="analytics-content">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Table View -->
        <div id="view-table" class="view-container active">
            <div class="task-table-container">
                <table class="task-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th> <!-- Expansion Arrow -->
                            <th>Title</th>
                            <th>Start Date</th>
                            <th>Due Date</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Progress</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History View -->
        <div id="view-history" class="view-container">
            <div class="task-table-container">
                <table class="task-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"></th>
                            <th>Title</th>
                            <th>Start Date</th>
                            <th>Due Date</th>
                            <th>Category</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Progress</th> <!-- Added Progress for consistency -->
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="view-calendar" class="view-container">
            <div class="calendar-header">
                <button class="btn btn-outline" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <h3 id="calendar-month-year" style="margin:0">Month Year</h3>
                <button class="btn btn-outline" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div id="calendar-grid" class="calendar-grid"></div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" style="margin-top:0">New Task</h2>
            <form id="task-form" onsubmit="saveTask(event)">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="inp-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="inp-desc" class="form-control"></textarea>
                </div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Start Date</label>
                        <input type="date" id="inp-start" class="form-control">
                    </div>
                    <div style="flex:1">
                        <label>Due Date</label>
                        <input type="date" id="inp-due" class="form-control" required>
                    </div>
                </div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Category</label>
                        <input type="text" id="inp-cat" class="form-control" list="cat-list">
                        <datalist id="cat-list"></datalist>
                    </div>
                    <div style="flex:1">
                        <label>Priority</label>
                        <select id="inp-prio" class="form-control">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="inp-status" class="form-control">
                        <option value="ToDo">To Do</option>
                        <option value="InProgress">In Progress</option>
                        <option value="Completed">Completed</option>
                        <option value="Overdue" disabled>Overdue (Auto)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Recurrence</label>
                    <select id="inp-recurring" class="form-control" onchange="toggleCustomRecurring()">
                        <option value="None">None</option>
                        <option value="Daily">Daily</option>
                        <option value="Weekly">Weekly</option>
                        <option value="Monthly">Monthly</option>
                        <option value="Custom">Custom</option>
                    </select>
                    <input type="text" id="inp-recurring-custom" class="form-control" placeholder="e.g. Every 2 weeks"
                        style="display:none; margin-top:5px;">
                </div>
                <div class="form-group">
                    <label>Subtasks (One per line)</label>
                    <textarea id="inp-subtasks" class="form-control" placeholder="Subtask 1\nSubtask 2"></textarea>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px;">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content" style="width: 400px;">
            <h2 style="margin-top:0">Filter Tasks</h2>
            <div class="form-group" id="group-filter-status">
                <label>Status</label>
                <select id="f-status" class="form-control">
                    <option value="all">All Status</option>
                    <option value="ToDo">To Do</option>
                    <option value="InProgress">In Progress</option>
                    <option value="Overdue">Overdue</option>
                </select>
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="f-category" class="form-control">
                    <option value="all">All Categories</option>
                </select>
            </div>
            <div class="form-group">
                <label>Priority</label>
                <select id="f-prio" class="form-control">
                    <option value="all">All Priorities</option>
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                </select>
            </div>
            <div class="form-group">
                <label>Due Before</label>
                <input type="date" id="f-date" class="form-control">
            </div>
            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button type="button" class="btn btn-outline" style="border-color: #f44336; color: #f44336"
                    onclick="clearFilters()">Clear Filters</button>
                <div style="display:flex; gap:10px;">
                    <button type="button" class="btn btn-outline" onclick="closeFilterModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State
        let allTasks = [];
        let editingId = null;
        let currentCalendarDate = new Date();
        let currentView = 'table';
        let analyticsMode = 'overall'; // overall, recurring, non-recurring
        let analyticsCharts = []; // Store chart instances to destroy them on update

        // Filter State
        let filterState = {
            status: 'all',
            category: 'all',
            priority: 'all',
            date: '' // Due on or before
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Theme sync
            window.addEventListener('message', (e) => {
                if (e.data.type === 'theme-change') {
                    document.documentElement.setAttribute('data-theme', e.data.theme);
                } else if (e.data.type === 'open-modal') {
                    openModal();
                }
            });
            if (window.parent) window.parent.postMessage({ type: 'request-theme' }, '*');

            // Set default dates
            document.getElementById('inp-start').valueAsDate = new Date();

            fetchTasks();
        });

        // API
        async function fetchTasks() {
            try {
                const res = await fetch('/api/storage/tasks.json');
                allTasks = await res.json();
                if (!Array.isArray(allTasks)) allTasks = [];
                checkOverdueTasks(); // Auto-check on load
                updateCategoryList();
                renderAllViews();
            } catch (e) {
                console.error("Failed to load tasks", e);
            }
        }

        function checkOverdueTasks() {
            const today = new Date().toISOString().split('T')[0];
            let changed = false;

            allTasks.forEach(t => {
                if (t.status === 'Completed') return;

                // If due date is strictly less than today (yesterday or before)
                if (t.dueDate && t.dueDate < today && t.status !== 'Overdue') {
                    t.status = 'Overdue';
                    t.priority = 'High';
                    changed = true;
                }
            });

            if (changed) saveTasksToStorage();
        }

        async function saveTasksToStorage() {
            try {
                await fetch('/api/storage/tasks.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: allTasks })
                });
            } catch (e) { console.error("Save failed", e); }
        }

        // Views
        function switchView(viewName) {
            currentView = viewName;
            document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navs = document.querySelectorAll('.nav-item');
            if (viewName === 'analytics') navs[0].classList.add('active');
            if (viewName === 'table') navs[1].classList.add('active');
            if (viewName === 'history') navs[2].classList.add('active');
            if (viewName === 'calendar') navs[3].classList.add('active');

            // Re-render to ensure fresh data
            if (viewName === 'calendar') renderCalendar();
            else if (viewName === 'table') renderTasks();
            else if (viewName === 'history') renderHistory();
            else if (viewName === 'analytics') renderAnalytics();

            // Reset filters logic could be here if we wanted per-view isolation, 
            // but user asked for consolidation. 
            // However, Status status filter only applies to Table view.
        }

        function renderAllViews() {
            renderTasks();
            renderHistory();
            renderCalendar();
        }

        // Filters
        function openFilterModal() {
            // Load current state
            document.getElementById('f-status').value = filterState.status;
            document.getElementById('f-category').value = filterState.category;
            document.getElementById('f-prio').value = filterState.priority;
            document.getElementById('f-date').value = filterState.date;

            // Context awareness
            const statusGroup = document.getElementById('group-filter-status');
            if (currentView === 'history') {
                statusGroup.style.display = 'none';
            } else {
                statusGroup.style.display = 'block';
            }

            document.getElementById('filter-modal').classList.add('open');
        }

        function closeFilterModal() {
            document.getElementById('filter-modal').classList.remove('open');
        }

        function applyFilters() {
            filterState.status = document.getElementById('f-status').value;
            filterState.category = document.getElementById('f-category').value;
            filterState.priority = document.getElementById('f-prio').value;
            filterState.date = document.getElementById('f-date').value;

            closeFilterModal();
            renderAllViews();
        }

        function clearFilters() {
            filterState = {
                status: 'all',
                category: 'all',
                priority: 'all',
                date: ''
            };
            closeFilterModal();
            renderAllViews();
        }

        // Helper for Sorting
        function compareTasks(a, b) {
            // 1. Due Date (Ascending)
            if (a.dueDate !== b.dueDate) {
                if (!a.dueDate) return 1; // No date -> end
                if (!b.dueDate) return -1;
                return a.dueDate.localeCompare(b.dueDate);
            }

            // 2. Status (Overdue -> ToDo -> InProgress -> Completed)
            const statusWeight = { 'Overdue': 0, 'ToDo': 1, 'InProgress': 2, 'Completed': 3 };
            if (statusWeight[a.status] !== statusWeight[b.status]) {
                return (statusWeight[a.status] || 99) - (statusWeight[b.status] || 99);
            }

            // 3. Priority (High -> Medium -> Low)
            const priorityWeight = { 'High': 1, 'Medium': 2, 'Low': 3 };
            return (priorityWeight[a.priority] || 99) - (priorityWeight[b.priority] || 99);
        }

        // Render Main Table
        function renderTasks() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const statusCtx = document.getElementById('f-status').value;
            const catCtx = document.getElementById('f-category').value;
            const dateCtx = document.getElementById('f-date').value;

            // Apply Sort
            const sortedTasks = [...allTasks].sort(compareTasks);

            sortedTasks.forEach(task => {
                if (task.status === 'Completed') return; // Hide completed in main table

                // Filter Logic
                if (filterState.status !== 'all' && task.status !== filterState.status) return;
                if (filterState.category !== 'all' && task.category !== filterState.category) return;
                if (filterState.priority !== 'all' && task.priority !== filterState.priority) return;
                if (filterState.date && task.dueDate) {
                    if (task.dueDate > filterState.date) return;
                }

                tbody.innerHTML += createTaskRow(task);
            });
        }

        // Render History Table
        function renderHistory() {
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';

            // Apply Sort
            const sortedTasks = [...allTasks].sort(compareTasks);

            sortedTasks.forEach(task => {
                if (task.status !== 'Completed') return; // Only completed in history

                // History ignores status filter (it is always Completed)
                if (filterState.category !== 'all' && task.category !== filterState.category) return;
                if (filterState.priority !== 'all' && task.priority !== filterState.priority) return;
                if (filterState.date && task.dueDate) {
                    if (task.dueDate > filterState.date) return;
                }

                tbody.innerHTML += createTaskRow(task);
            });
        }

        function createTaskRow(task) {
            // Calculate Progress
            let progress = "-";
            if (task.subtasks && task.subtasks.length > 0) {
                const done = task.subtasks.filter(s => s.done).length;
                progress = Math.round((done / task.subtasks.length) * 100) + "%";
            }

            return `
                <tr onclick="if(!event.target.closest('button') && !event.target.closest('select')) toggleRow('${task.id}')" style="cursor:pointer">
                    <td style="text-align:center"><i class="fas fa-chevron-right" id="arrow-${task.id}"></i></td>
                    <td style="font-weight:500">
                        ${task.title}
                        ${(task.recurring && task.recurring !== 'None') ? '<i class="fas fa-sync-alt" style="font-size:0.75em; margin-left:5px; color:var(--primary-color)" title="Recurring: ' + task.recurring + '"></i>' : ''}
                    </td>
                    <td>${task.startDate || '-'}</td>
                    <td>${task.dueDate}</td>
                    <td>${task.category || '-'}</td>
                    <td class="priority-badge priority-${task.priority.toLowerCase()}">${task.priority}</td>
                <td>
                    ${generateStatusSelect(task)}
                </td>
                <td>${progress}</td>
                    <td>
                        <i class="fas fa-pen action-icon" onclick="editTask('${task.id}'); event.stopPropagation()"></i>
                        <i class="fas fa-trash action-icon delete" onclick="deleteTask('${task.id}'); event.stopPropagation()"></i>
                    </td>
                </tr>
                <tr id="expand-${task.id}" class="expanded-row">
                    <td colspan="9" class="expanded-content">
                        <p><strong>Description:</strong> ${task.description || 'None'}</p>
                        ${renderSubtasks(task)}
                    </td>
                </tr>
            `;
        }

        function renderSubtasks(task) {
            if (!task.subtasks || task.subtasks.length === 0) return '';
            return `<div style="margin-top:10px">
                <strong>Subtasks:</strong>
                ${task.subtasks.map((s, idx) => `
                    <div style="margin-left:15px; margin-top:5px;">
                        <input type="checkbox" ${s.done ? 'checked' : ''} onchange="toggleSubtask('${task.id}', ${idx})"> ${s.text}
                    </div>
                `).join('')}
            </div>`;
        }

        function toggleRow(id) {
            const row = document.getElementById(`expand-${id}`);
            const arrow = document.getElementById(`arrow-${id}`);
            if (row.classList.contains('show')) {
                row.classList.remove('show');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                row.classList.add('show');
                arrow.style.transform = 'rotate(90deg)';
            }
        }

        function generateStatusSelect(task) {
            const isOverdue = task.status === 'Overdue';
            if (isOverdue) {
                return `
                    <select class="status-select status-overdue" onchange="updateStatus('${task.id}', this.value)" onclick="event.stopPropagation()">
                        <option value="Overdue" selected>Overdue</option>
                        <option value="Completed">Completed</option>
                    </select>
                 `;
            }

            return `
                <select class="status-select" onchange="updateStatus('${task.id}', this.value)" onclick="event.stopPropagation()">
                    <option value="ToDo" ${task.status === 'ToDo' ? 'selected' : ''}>To Do</option>
                    <option value="InProgress" ${task.status === 'InProgress' ? 'selected' : ''}>In Progress</option>
                    <option value="Completed" ${task.status === 'Completed' ? 'selected' : ''}>Completed</option>
                </select>
             `;
        }

        // Logic
        function saveTask(e) {
            e.preventDefault();
            const id = document.getElementById('task-id').value || Date.now().toString();

            const startDate = document.getElementById('inp-start').value;
            const dueDate = document.getElementById('inp-due').value;

            // Validator
            if (startDate && dueDate && dueDate < startDate) {
                alert("Due Date cannot be earlier than Start Date.");
                return;
            }

            const subtext = document.getElementById('inp-subtasks').value;
            const subtasks = subtext.split('\n').filter(t => t.trim()).map(t => ({ text: t.trim(), done: false }));

            const task = {
                id: id,
                title: document.getElementById('inp-title').value,
                description: document.getElementById('inp-desc').value,
                startDate: document.getElementById('inp-start').value,
                dueDate: document.getElementById('inp-due').value,
                category: document.getElementById('inp-cat').value,
                priority: document.getElementById('inp-prio').value,
                status: document.getElementById('inp-status').value,
                recurring: document.getElementById('inp-recurring').value === 'Custom'
                    ? document.getElementById('inp-recurring-custom').value
                    : document.getElementById('inp-recurring').value,
                subtasks: subtasks
            };

            if (editingId) {
                const idx = allTasks.findIndex(t => t.id === editingId);
                if (idx !== -1) {
                    const old = allTasks[idx];
                    task.subtasks = subtasks.map(s => {
                        const existing = old.subtasks.find(os => os.text === s.text);
                        return existing ? { ...s, done: existing.done } : s;
                    });
                    allTasks[idx] = task;
                }
            } else {
                allTasks.push(task);
            }

            saveTasksToStorage();
            closeModal();
            fetchTasks();
        }

        function updateStatus(id, newStatus) {
            const task = allTasks.find(t => t.id === id);
            if (task) {
                // If moving back to active status (not Completed), check if it's already overdue
                const today = new Date().toISOString().split('T')[0];
                if (newStatus !== 'Completed' && newStatus !== 'Overdue' && task.dueDate && task.dueDate < today) {
                    newStatus = 'Overdue';
                    task.priority = 'High';
                    // Optional: could alert the user here, but auto-switching is smoother logic
                }

                task.status = newStatus;
                saveTasksToStorage();
                renderAllViews();
            }
        }

        function editTask(id) {
            const task = allTasks.find(t => t.id === id);
            if (!task) return;
            editingId = id;
            document.getElementById('task-id').value = task.id;
            document.getElementById('inp-title').value = task.title;
            document.getElementById('inp-desc').value = task.description;
            document.getElementById('inp-start').value = task.startDate;
            document.getElementById('inp-due').value = task.dueDate;
            document.getElementById('inp-cat').value = task.category;
            document.getElementById('inp-prio').value = task.priority;
            document.getElementById('inp-prio').value = task.priority;
            document.getElementById('inp-status').value = task.status;

            // Recurrence Logic
            const stdRecur = ['None', 'Daily', 'Weekly', 'Monthly'];
            if (stdRecur.includes(task.recurring || 'None')) {
                document.getElementById('inp-recurring').value = task.recurring || 'None';
                document.getElementById('inp-recurring-custom').style.display = 'none';
            } else {
                document.getElementById('inp-recurring').value = 'Custom';
                document.getElementById('inp-recurring-custom').style.display = 'block';
                document.getElementById('inp-recurring-custom').value = task.recurring;
            }

            document.getElementById('inp-subtasks').value = (task.subtasks || []).map(s => s.text).join('\n');

            document.getElementById('modal-title').textContent = "Edit Task";
            document.getElementById('task-modal').classList.add('open');
        }

        function deleteTask(id) {
            if (confirm("Delete this task?")) {
                allTasks = allTasks.filter(t => t.id !== id);
                saveTasksToStorage();
                renderAllViews();
            }
        }

        function toggleSubtask(taskId, subIdx) {
            const task = allTasks.find(t => t.id === taskId);
            if (task && task.subtasks[subIdx]) {
                task.subtasks[subIdx].done = !task.subtasks[subIdx].done;
                saveTasksToStorage();
                allTasks = [...allTasks]; // Trigger updates if needed?? no regular ref obj
                renderAllViews(); // update progress bar
            }
        }

        // Helpers
        function openModal() {
            editingId = null;
            document.getElementById('task-form').reset();
            document.getElementById('task-id').value = '';
            document.getElementById('inp-start').valueAsDate = new Date();
            document.getElementById('modal-title').textContent = "New Task";
            document.getElementById('task-modal').classList.add('open');
        }
        function closeModal() {
            document.getElementById('task-modal').classList.remove('open');
        }

        function updateCategoryList() {
            const cats = [...new Set(allTasks.map(t => t.category).filter(Boolean))];
            const dl = document.getElementById('cat-list');
            const filter = document.getElementById('f-category');

            dl.innerHTML = cats.map(c => `<option value="${c}">`).join('');

            const opts = '<option value="all">All Categories</option>' +
                cats.map(c => `<option value="${c}">${c}</option>`).join('');
            filter.innerHTML = opts;
        }

        function exportTasks() {
            const headers = ["Title", "Date", "Due Date", "Status", "Priority", "Category", "Description"];
            const rows = allTasks.map(t => [
                t.title, t.startDate, t.dueDate, t.status, t.priority, t.category, t.description
            ]);

            let csvContent = "data:text/csv;charset=utf-8,"
                + headers.join(",") + "\n"
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "tasks_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Calendar Logic
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthLabel = document.getElementById('calendar-month-year');
            grid.innerHTML = '';

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            // Format Header
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthLabel.textContent = `${monthNames[month]} ${year}`;

            // Logic for grid
            const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            // Previous Month Fillers
            for (let i = 0; i < firstDayOfMonth; i++) {
                const dayNum = daysInPrevMonth - firstDayOfMonth + 1 + i;
                grid.innerHTML += `<div class="calendar-cell other-month"><span class="day-number">${dayNum}</span></div>`;
            }

            // Current Month
            for (let i = 1; i <= daysInMonth; i++) {
                // Find tasks for this day
                const tasksForDay = allTasks.filter(t => {
                    if (!t.dueDate) return false;
                    const d = new Date(t.dueDate);
                    return d.getDate() === i && d.getMonth() === month && d.getFullYear() === year;
                });

                const taskHtml = tasksForDay.map(t => `
                    <div class="task-dot" title="${t.title}" onclick="editTask('${t.id}')">
                        ${t.title}
                    </div>
                `).join('');

                grid.innerHTML += `<div class="calendar-cell">
                    <span class="day-number">${i}</span>
                    <div style="overflow-y:auto; flex:1; width:100%">${taskHtml}</div>
                </div>`;
            }

            // Next Month Fillers
            const totalCells = firstDayOfMonth + daysInMonth;
            const remaining = 42 - totalCells; // 6 rows of 7
            for (let i = 1; i <= remaining; i++) {
                grid.innerHTML += `<div class="calendar-cell other-month"><span class="day-number">${i}</span></div>`;
            }
        }

        // --- Analytics Logic ---

        function switchAnalyticsTab(mode) {
            analyticsMode = mode;
            document.querySelectorAll('.analytics-tab').forEach(el => el.classList.remove('active'));
            // Find the tab with the text matching the mode roughly or just use index? 
            // Better to add IDs or just check context.
            const textMap = { 'overall': 'Overall', 'recurring': 'Recurring', 'non-recurring': 'Non-Recurring' };
            Array.from(document.querySelectorAll('.analytics-tab')).find(el => el.textContent === textMap[mode]).classList.add('active');
            renderAnalytics();
        }

        function calculateStats(tasks) {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'Completed').length;
            const overdue = tasks.filter(t => t.status === 'Overdue').length;

            const today = new Date().toISOString().split('T')[0];
            const dueToday = tasks.filter(t => t.dueDate === today && t.status !== 'Completed').length;

            const score = total === 0 ? 0 : Math.round((completed / total) * 100);

            // Distributions
            const statusDist = { 'ToDo': 0, 'InProgress': 0, 'Completed': 0, 'Overdue': 0 };
            const priorityDist = { 'High': 0, 'Medium': 0, 'Low': 0 };
            const categoryDist = {};

            tasks.forEach(t => {
                if (statusDist[t.status] !== undefined) statusDist[t.status]++;
                if (priorityDist[t.priority] !== undefined) priorityDist[t.priority]++;

                const cat = t.category || 'Uncategorized';
                categoryDist[cat] = (categoryDist[cat] || 0) + 1;
            });

            return { total, completed, overdue, dueToday, score, statusDist, priorityDist, categoryDist };
        }

        function renderAnalytics() {
            const container = document.getElementById('analytics-content');

            // Filter Data based on Mode
            let dataset = [];
            if (analyticsMode === 'overall') dataset = allTasks;
            else if (analyticsMode === 'recurring') dataset = allTasks.filter(t => t.recurring && t.recurring !== 'None');
            else if (analyticsMode === 'non-recurring') dataset = allTasks.filter(t => !t.recurring || t.recurring === 'None');

            const stats = calculateStats(dataset);

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${stats.score}%</div>
                        <div class="stat-label">Productivity Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total}</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:#f44336">${stats.overdue}</div>
                        <div class="stat-label">Overdue</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:#ff9800">${stats.dueToday}</div>
                        <div class="stat-label">Due Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" style="color:#4caf50">${stats.completed}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h4>Status</h4>
                        <div class="chart-wrapper"><canvas id="chart-status"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Priority</h4>
                        <div class="chart-wrapper"><canvas id="chart-prio"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <h4>Category</h4>
                        <div class="chart-wrapper"><canvas id="chart-cat"></canvas></div>
                    </div>
                </div>
            `;

            // Render Charts
            analyticsCharts.forEach(c => c.destroy());
            analyticsCharts = [];

            // Metrics Logic...
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, padding: 10 } }
                },
                layout: { padding: 0 }
            };

            const colors = {
                status: ['#2196f3', '#ff9800', '#4caf50', '#f44336'],
                priority: ['#f44336', '#ff9800', '#4caf50'],
                bg: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40']
            };

            // 1. Status Chart
            const ctxStatus = document.getElementById('chart-status').getContext('2d');
            analyticsCharts.push(new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['To Do', 'In Progress', 'Completed', 'Overdue'],
                    datasets: [{
                        data: [stats.statusDist.ToDo, stats.statusDist.InProgress, stats.statusDist.Completed, stats.statusDist.Overdue],
                        backgroundColor: colors.status
                    }]
                },
                options: commonOptions
            }));

            // 2. Priority Chart
            const ctxPrio = document.getElementById('chart-prio').getContext('2d');
            analyticsCharts.push(new Chart(ctxPrio, {
                type: 'doughnut',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [stats.priorityDist.High, stats.priorityDist.Medium, stats.priorityDist.Low],
                        backgroundColor: colors.priority
                    }]
                },
                options: commonOptions
            }));

            // 3. Category Chart
            const catLabels = Object.keys(stats.categoryDist);
            const catData = Object.values(stats.categoryDist);
            const ctxCat = document.getElementById('chart-cat').getContext('2d');
            analyticsCharts.push(new Chart(ctxCat, {
                type: 'doughnut',
                data: {
                    labels: catLabels,
                    datasets: [{
                        data: catData,
                        backgroundColor: colors.bg
                    }]
                },
                options: commonOptions
            }));
        }
    </script>
</body>

</html>